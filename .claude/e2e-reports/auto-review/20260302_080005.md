# Auto E2E Review - 2026-03-02 08:00

## 이전 리뷰
- 파일: `20260226_000000.md`
- 이전 미해결: 5건 (권고사항, 수정 불필요)

## 리뷰 결과

| Phase | 상태 | 수정 | 미해결 |
|-------|------|------|--------|
| Phase 1: Build & Lint | ✅ 통과 | 0건 | 0 |
| Phase 2: Security | ✅ 수정 | 1건 (rate limiting) | 0 |
| Phase 3: Performance | ✅ 수정 | 1건 (query invalidation) | 0 |
| Phase 4: UX 핵심 플로우 | ✅ 통과 | 0건 | 0 |
| Phase 5: UX 에러 복구 | ✅ 수정 | 1건 (retry button) | 0 |
| Phase 6: UX 상태 표시 | ✅ 통과 | 0건 | 0 |
| Phase 7: DB & 스키마 | ✅ 통과 | 0건 | 0 |
| Phase 8: PWA & 알림 | ✅ 통과 | 0건 | 0 |

## 수정 내역

### Phase 2: Rate Limiting 추가 (1건)

1. `backend/src/presentation/controllers/insights.controller.ts:110` + `backend/src/presentation/controllers/congestion.controller.ts:86` — `recalculate` 엔드포인트에 개별 rate limiting 미적용. 전체 DB를 재계산하는 고비용 작업이므로 DoS 공격 벡터가 될 수 있음. `@Throttle({ default: { limit: 1, ttl: 300000 } })` 데코레이터를 추가하여 5분당 1회로 제한.
   - 변경 전: rate limit 없음 (글로벌 60/min만 적용)
   - 변경 후: `@Throttle({ default: { limit: 1, ttl: 300000 } })` 개별 적용

### Phase 3: Query Cache Invalidation 범위 축소 (1건)

2. `frontend/src/infrastructure/query/use-community-query.ts:55-57,65-67` — `useMarkHelpful`과 `useReportTip` mutation의 `onSuccess`에서 `queryKeys.community.all`(= `['community']`)을 invalidate하여 neighbor stats까지 불필요하게 refetch됨. 이 두 액션은 tips 데이터만 변경하므로 `['community', 'tips']`로 범위를 축소하여 불필요한 API 호출 제거.
   - 변경 전: `void qc.invalidateQueries({ queryKey: queryKeys.community.all });`
   - 변경 후: `void qc.invalidateQueries({ queryKey: ['community', 'tips'] });`

### Phase 5: InsightsPage 에러 상태 retry 버튼 추가 (1건)

3. `frontend/src/presentation/pages/insights/InsightsPage.tsx:67-75` — InsightsPage 에러 상태에 재시도 버튼이 없어 사용자가 에러 발생 시 새로고침 외 복구 방법이 없었음. 다른 페이지(ReportPage, MissionSettingsPage)와의 UX 일관성을 위해 retry 버튼 추가.
   - `useRegions`에서 `refetch` 추출
   - 에러 영역에 `<button className="insights-retry-btn" onClick={() => void refetch()}>다시 시도</button>` 추가
   - `insights.css`에 `.insights-error`, `.insights-retry-btn` 스타일 추가 (WCAG 44px 터치 타겟 준수)

## 미해결 이슈

### 이전 리뷰 권고사항 (변경 없음)

1. **[Phase 2] 알림톡 템플릿 ID 하드코딩** — `backend/src/infrastructure/messaging/solapi.service.ts`. 7개 템플릿 ID가 코드에 하드코딩됨. 환경변수/ConfigService 마이그레이션 권장하나 공개 정보이므로 보안 위험 낮음.

2. **[Phase 5] 500 에러 메시지 통칭 처리** — API 클라이언트가 상태코드만 throw하므로 상세 메시지 전달 제한.

3. **[Phase 5] 외부 API 실패 시 폴백 부재** — 날씨/교통 API 실패 시 캐시 데이터 활용 미흡.

4. **[Phase 5] 새로고침 시 폼 상태 미보존** — RouteSetupPage, CommuteTrackingPage에서 sessionStorage 미활용.

5. **[Phase 6] 모바일 터치 타겟** — 일부 아이콘 버튼이 Apple 권장 44px 미만.

### 신규 권고사항

6. **[Phase 5] use-home-data.ts silent failure** — `frontend/src/presentation/pages/home/use-home-data.ts`에서 prediction API 실패 시 `console.warn`만 출력하고 에러를 무시. 비핵심 위젯이므로 현재 동작이 합리적이나, 향후 중요도가 올라가면 사용자 피드백 추가 고려.

7. **[Phase 2] alternative mappings admin role check** — `backend/src/presentation/controllers/alternative.controller.ts`의 매핑 생성 엔드포인트에 admin 권한 체크 없음. 현재 인증된 사용자만 접근 가능하므로 저위험이나, 장기적으로 role-based 접근 제어 권장.

## 검증 결과 상세

### Frontend
| 항목 | 결과 |
|------|------|
| typecheck | ✅ 에러 0 |
| build | ✅ gzip ~168KB (제한 500KB) |
| test | ✅ 46 suites, 594 passed |

### Backend
| 항목 | 결과 |
|------|------|
| typecheck | ✅ 에러 0 |
| build | ✅ 성공 |
| test | ✅ 101 suites, 1348 passed, 10 skipped |

## Phase별 점검 요약

### Phase 1: Build & Lint
- Frontend: TypeScript strict mode 통과, Vite build 성공 (~168KB gzip)
- Backend: TypeScript 통과, NestJS build 성공

### Phase 2: Security
- JWT 인증 + bcrypt + timingSafeEqual ✅
- CORS 화이트리스트 ✅
- Helmet CSP ✅
- Rate Limiting (ThrottlerModule 60/min + 로그인 5/min + recalculate 1/5min) ✅
- ValidationPipe (whitelist + forbidNonWhitelisted) ✅
- 하드코딩된 시크릿 없음, SSM Parameter Store 사용 ✅
- userId 검증: 모든 컨트롤러에서 일관 적용 ✅
- SQL injection 방지: community-tip repository 등 모두 parameterized query 사용 ✅

### Phase 3: Performance
- 모든 12개+ 페이지 lazy loading + idle preload + nav prefetch ✅
- API 캐싱: React Query staleTime 적절 설정 ✅
- Query invalidation: community mutation 범위 축소 ✅ (이번 리뷰)
- useMemo/useCallback 적절 사용, 과도한 메모이제이션 없음 ✅
- 번들 사이즈: ~168KB gzip (500KB 제한 이내) ✅
- N+1 쿼리: 이전 리뷰에서 수정 완료, 추가 발견 없음 ✅

### Phase 4: UX 핵심 플로우
- 경로 설정: 비로그인 → 로그인 유도, 폼 제출 → 리다이렉트, 삭제 확인 ✅
- 알림 설정: CRUD 완전, 삭제 확인 다이얼로그 ✅
- 출퇴근 추적: 세션 시작/체크포인트/완료 플로우 명확, 취소 확인 ✅
- 커뮤니티 (신규): 익명 경로 공동체, 체크포인트 팁 CRUD ✅
- 혼잡도 (신규): 세그먼트 혼잡도 칩 + 경로 오버레이 ✅
- 인사이트 (신규): 지역별 통계, 비교, 피크 시간 차트 ✅
- 지연 알림 (신규): 지연 배너 + 대안 경로 UI ✅
- JSX 조건부 렌더링: 모순 조건 없음, 명확 분리 ✅

### Phase 5: UX 에러 복구
- API 에러 처리: 모든 주요 페이지에서 에러 메시지 표시 ✅
- 401 인증 만료: 명시적 감지 + 사용자 친화적 메시지 ✅
- 재시도 버튼: 홈, 대시보드, 미션, 인사이트 페이지 ✅
- InsightsPage retry 버튼 추가 ✅ (이번 리뷰)

### Phase 6: UX 상태 표시
- 로딩 상태: 모든 페이지에서 스켈레톤/스피너 표시 ✅
- 빈 상태: EmptyState 컴포넌트 + 안내 메시지 + CTA ✅
- 버튼 상태: disabled/loading 적절 표시 ✅

### Phase 7: DB & Schema
- 모든 엔티티에서 `alert_system` 스키마 사용 ✅
- public 스키마 사용 없음 ✅
- userId 기반 필터링 적용 ✅
- SQL injection 방지: parameterized query ✅

### Phase 8: PWA & Notifications
- VitePWA injectManifest 모드 ✅
- 서비스 워커 캐싱 전략 (StaleWhileRevalidate, CacheFirst, NetworkFirst) ✅
- VAPID 푸시 알림 ✅
- EventBridge Scheduler 영구 스케줄 ✅
- Solapi 알림톡 7개 템플릿 ✅

## 신규 코드 리뷰 (P4 피처 + P3 지연 알림)

이전 리뷰(2026-02-26) 이후 15개 커밋이 추가됨. 주요 변경:
- 커뮤니티 도메인: 익명 경로 공동체 + 체크포인트 팁 (P4-3)
- 지역별 인사이트: 통근 통계, 비교, 피크 시간 (P4-2)
- 혼잡도 파이프라인: Bayesian 집계, 세그먼트 칩, 경로 오버레이 (P4-1)
- 지연 알림: 배너 + 대안 경로 UI (P3-5)
- 패턴 ML: streak/milestone 배지 시스템
- 대안 경로: delay + alternative route 모듈

신규 코드 품질:
- ✅ Clean Architecture 준수: domain/application/infrastructure/presentation 분리
- ✅ React Query 적절 사용: staleTime 설정, mutation invalidation
- ✅ 접근성: aria-label, aria-live, role 적절 적용
- ✅ 로딩/에러/빈 상태 모두 처리
- ✅ TypeScript strict mode 준수
- ✅ 테스트 커버리지: 신규 모듈 unit test 포함

## 통계
- 총 체크: ~85건 / 통과: 82건 / 수정: 3건 / 미해결: 7건 (권고사항)
