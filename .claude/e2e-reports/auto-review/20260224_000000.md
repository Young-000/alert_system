# E2E Auto Review Report — 2026-02-24

> 자동 E2E 리뷰 결과 보고서

---

## Summary

| 항목 | 결과 |
|------|------|
| 실행일 | 2026-02-24 |
| 브랜치 | `feature/e2e-auto-review-20260224` |
| 수정 건수 | **3건** (N+1 쿼리 배치 최적화) |
| Frontend Build | gzip ~196KB (PASS) |
| Backend Build | PASS |
| Frontend Tests | 381 passed / 28 suites |
| Backend Tests | 675 passed / 62 suites (10 skipped) |

---

## Phase Results

### Phase 1: Build & Lint ✅

| 항목 | 결과 |
|------|------|
| 1-1 Frontend Lint | PASS (0 errors) |
| 1-2 Backend Lint | PASS (0 errors) |
| 1-3 Frontend Type Check | PASS |
| 1-4 Frontend Build | PASS (196.6KB gzip) |
| 1-5 Backend Build | PASS |
| 1-6 Frontend Tests | PASS (381 passed) |
| 1-7 Backend Tests | PASS (675 passed) |

### Phase 2: Security ✅

| 항목 | 결과 |
|------|------|
| 2-1 환경변수 하드코딩 | PASS — 모든 시크릿 SSM/env에서 관리 |
| 2-2 JWT 인증 | PASS — GlobalGuard + @Public 데코레이터 패턴 |
| 2-3 입력 검증 | PASS — class-validator DTO + ValidationPipe |
| 2-4 CORS | PASS — 환경별 origin 설정 |
| 2-5 RLS | PASS — Supabase PostgreSQL RLS 활성화 |

### Phase 3: Performance ⚠️ → ✅ (3건 수정)

| 항목 | 결과 |
|------|------|
| 3-1 번들 사이즈 | PASS (196.6KB < 500KB 제한) |
| 3-2 코드 스플리팅 | PASS (11개 페이지 모두 lazy) |
| 3-3 API 캐싱 | PASS (4개 외부 API 캐시 적용) |
| 3-4 N+1 쿼리 | **3건 수정** (아래 상세) |

#### N+1 수정 상세

**Fix 1: generate-weekly-report.use-case.ts** (심각도: HIGH)
- 문제: `execute()` 루프 안에서 `userRepository.findById(userId)` 개별 호출
- 수정: `userRepository.findByIds(activeUserIds)` 배치 조회 + Map lookup
- 영향: 사용자 수만큼 쿼리 → 1개 쿼리

**Fix 2: manage-commute-session.use-case.ts** (심각도: MEDIUM)
- 문제: `getHistory()` 루프 안에서 `routeRepository.findById(routeId)` 개별 호출
- 수정: `routeRepository.findByIds(routeIds)` 배치 조회 + Map lookup
- 영향: 고유 경로 수만큼 쿼리 → 1개 쿼리

**Fix 3: process-commute-event.use-case.ts** (심각도: MEDIUM)
- 문제: `getEventsByUserId()` 루프 안에서 `placeRepository.findById(placeId)` 개별 호출
- 수정: `placeRepository.findByIds(placeIds)` 배치 조회 + Map lookup
- 영향: 고유 장소 수만큼 쿼리 → 1개 쿼리

#### 인프라 변경 (N+1 수정 지원)

| 파일 | 변경 |
|------|------|
| `domain/repositories/user.repository.ts` | `findByIds` 인터페이스 추가 |
| `domain/repositories/commute-route.repository.ts` | `findByIds` 인터페이스 추가 |
| `domain/repositories/user-place.repository.ts` | `findByIds` 인터페이스 추가 |
| `infrastructure/persistence/postgres-user.repository.ts` | `findByIds` 구현 (TypeORM `In()`) |
| `infrastructure/persistence/repositories/commute-route.repository.ts` | `findByIds` 구현 |
| `infrastructure/persistence/repositories/user-place.repository.ts` | `findByIds` 구현 |
| 테스트 파일 9개 | mock에 `findByIds` 추가 |

#### 미수정 N+1 (낮은 우선순위)

- `calculate-departure.use-case.ts`: 루프 내 `routeRepo.findById()` — N이 매우 작음 (설정 수 < 5)
- `send-notification.use-case.ts`: 루프 내 `subwayStationRepository.findById()` — 최대 2회

### Phase 4: Core UX Flows ✅

| 항목 | 결과 |
|------|------|
| 4-1 경로 설정 (/routes) | PASS — 로그인 가드, 템플릿 저장→리다이렉트, CRUD 모두 정상 |
| 4-2 출퇴근 트래킹 (/commute) | PASS — 세션 시작/기록/완료/취소 모두 정상 |
| 4-3 알림 관리 (/alerts) | PASS — 위자드 플로우, 토글, 삭제 모두 정상 |

### Phase 5: Error Recovery ✅

| 항목 | 결과 |
|------|------|
| 5-1 API 에러 메시지 | PASS — 401/403/네트워크 등 구분 처리 |
| 5-2 오프라인 핸들링 | PASS — AbortController + 재시도 UI |
| 5-3 폼 검증 | PASS — 제출 전 validation, 버튼 disabled |

### Phase 6: State Consistency ⚠️

| 항목 | 결과 |
|------|------|
| 6-1 관련 상태 동시 업데이트 | CAUTION — RouteSetupPage cancelCreating()에서 setState 6+개 개별 호출. 실제 버그 가능성 LOW |
| 6-2 파생 상태 useMemo | PASS — 모든 파생 상태 useMemo 사용 |
| 6-3 useEffect 의존성 | PASS — 올바른 의존성 배열 |

### Phase 7: DB & Schema ✅

| 항목 | 결과 |
|------|------|
| 7-1 TypeORM 엔티티 제약 | PASS — nullable, defaults, types 올바름 |
| 7-2 인덱스 | PASS — userId, routeId, status 등 주요 컬럼 인덱싱 |
| 7-3 CASCADE 규칙 | PASS — route→checkpoints CASCADE 설정 정상 |

### Phase 8: PWA & Push ✅

| 항목 | 결과 |
|------|------|
| 8-1 VitePWA 설정 | PASS — injectManifest, 아이콘, shortcuts 설정 |
| 8-2 SW 등록 에러 처리 | PASS — catch, controllerchange, isRefreshing |
| 8-3 Web Push 구독 관리 | PASS — subscribe/unsubscribe/isPushSupported |

---

## 변경 파일 목록

### 수정 (Production Code)
1. `backend/src/domain/repositories/user.repository.ts` — findByIds 인터페이스 추가
2. `backend/src/domain/repositories/commute-route.repository.ts` — findByIds 인터페이스 추가
3. `backend/src/domain/repositories/user-place.repository.ts` — findByIds 인터페이스 추가
4. `backend/src/infrastructure/persistence/postgres-user.repository.ts` — findByIds 구현
5. `backend/src/infrastructure/persistence/repositories/commute-route.repository.ts` — findByIds 구현
6. `backend/src/infrastructure/persistence/repositories/user-place.repository.ts` — findByIds 구현
7. `backend/src/application/use-cases/generate-weekly-report.use-case.ts` — N+1 수정
8. `backend/src/application/use-cases/manage-commute-session.use-case.ts` — N+1 수정
9. `backend/src/application/use-cases/process-commute-event.use-case.ts` — N+1 수정

### 수정 (Test Code)
10. `backend/src/application/use-cases/generate-weekly-report.use-case.spec.ts` — findByIds mock
11. `backend/src/application/use-cases/get-user.use-case.spec.ts` — findByIds mock
12. `backend/src/application/use-cases/login.use-case.spec.ts` — findByIds mock
13. `backend/src/application/use-cases/get-air-quality.use-case.spec.ts` — findByIds mock
14. `backend/src/application/use-cases/create-user.use-case.spec.ts` — findByIds mock
15. `backend/src/application/use-cases/send-notification.use-case.spec.ts` — findByIds mock
16. `backend/src/application/use-cases/update-user-location.use-case.spec.ts` — findByIds mock
17. `backend/src/application/use-cases/create-alert.use-case.spec.ts` — findByIds mock
18. `backend/src/application/use-cases/export-user-data.use-case.spec.ts` — findByIds mock

---

## 미해결 권고사항 (이전 리뷰 이월)

| # | 항목 | 심각도 | 비고 |
|---|------|--------|------|
| 1 | Solapi 템플릿 ID 하드코딩 | LOW | 환경변수 이관 권고 |
| 2 | 500 에러 시 raw 메시지 노출 가능 | LOW | ExceptionFilter 개선 권고 |
| 3 | 외부 API fallback | LOW | 날씨/교통 API 장애 시 캐시 fallback |
| 4 | 폼 상태 보존 | LOW | 페이지 이탈 시 unsaved changes 경고 |
| 5 | 모바일 터치 타겟 24px | LOW | 일부 아이콘 버튼 44px 미달 |
