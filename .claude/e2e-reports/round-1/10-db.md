# DB Schema Review Report

**Date**: 2026-02-24
**Reviewer**: DB Schema Agent
**Status**: WARNING (issues found, 2 fixed)

---

## 1. Schema Usage (alert_system)

**Result: PASS**

All 26 TypeORM entities correctly use `{ schema: 'alert_system' }`:

| Entity | Table Name | Schema |
|--------|-----------|--------|
| UserEntity | users | alert_system |
| AlertEntity | alerts | alert_system |
| SubwayStationEntity | subway_stations | alert_system |
| WeatherCacheEntity | weather_cache | alert_system |
| AirQualityCacheEntity | air_quality_cache | alert_system |
| SubwayArrivalCacheEntity | subway_arrival_cache | alert_system |
| BusArrivalCacheEntity | bus_arrival_cache | alert_system |
| ApiCallLogEntity | api_call_log | alert_system |
| NotificationRuleEntity | notification_rules | alert_system |
| BehaviorEventEntity | behavior_events | alert_system |
| UserPatternEntity | user_patterns | alert_system |
| CommuteRecordEntity | commute_records | alert_system |
| CommuteRouteEntity | commute_routes | alert_system |
| RouteCheckpointEntity | route_checkpoints | alert_system |
| CommuteSessionEntity | commute_sessions | alert_system |
| CheckpointRecordEntity | checkpoint_records | alert_system |
| RouteAnalyticsEntity | route_analytics | alert_system |
| NotificationLogEntity | notification_logs | alert_system |
| PushSubscriptionEntity | push_subscriptions | alert_system |
| UserPlaceEntity | user_places | alert_system |
| CommuteEventEntity | commute_events | alert_system |
| SmartDepartureSettingEntity | smart_departure_settings | alert_system |
| SmartDepartureSnapshotEntity | smart_departure_snapshots | alert_system |
| ChallengeTemplateEntity | challenge_templates | alert_system |
| UserChallengeEntity | user_challenges | alert_system |
| UserBadgeEntity | user_badges | alert_system |
| LiveActivityTokenEntity | live_activity_tokens | alert_system |
| CommuteStreakOrmEntity | commute_streaks | alert_system |
| StreakDailyLogOrmEntity | streak_daily_logs | alert_system |

Frontend Supabase client also correctly sets `db: { schema: 'alert_system' }` in `frontend/src/infrastructure/supabase/client.ts`.

No public schema usage found anywhere.

---

## 2. Naming Convention Issues

### Table Names (snake_case, plural)

**5 tables use singular form instead of plural**:

| Current | Convention (plural) | Severity |
|---------|-------------------|----------|
| `weather_cache` | `weather_caches` | Low (existing data) |
| `air_quality_cache` | `air_quality_caches` | Low (existing data) |
| `subway_arrival_cache` | `subway_arrival_caches` | Low (existing data) |
| `bus_arrival_cache` | `bus_arrival_caches` | Low (existing data) |
| `api_call_log` | `api_call_logs` | Low (existing data) |

> **Not fixed**: Renaming tables requires a migration and could break production data. Flagged for future migration.

### Column Names (Boolean prefix convention)

**2 boolean columns missing `is_`/`has_` prefix**:

| Entity | Current Column | Convention |
|--------|---------------|------------|
| AlertEntity | `enabled` | `is_enabled` |
| NotificationRuleEntity | `enabled` | `is_enabled` |
| ApiCallLogEntity | `success` | `is_success` |

> **Not fixed**: Changing column names requires migration + all references update. Low priority.

### Other Column Names

All FK columns follow `{table_singular}_id` convention. Timestamps use `created_at`, `updated_at`. Other snake_case naming is consistent.

---

## 3. TypeORM Configuration

### FIXED: Missing Entity Registration

**Bug Found**: 3 entities were missing from `database.config.ts` (allEntities arrays) and `database.module.ts` (forFeature list):

1. `LiveActivityTokenEntity` - used in `live-activity.module.ts`
2. `CommuteStreakOrmEntity` - used in `commute.module.ts`
3. `StreakDailyLogOrmEntity` - used in `commute.module.ts`

**Impact**:
- **SQLite/E2E mode**: These entities would NOT be created in SQLite database, causing test failures
- **Postgres mode**: `autoLoadEntities: true` in forRoot covers this via forFeature in individual modules, but the explicit entity lists were inconsistent

**Files Modified**:
- `backend/src/infrastructure/persistence/database.config.ts` - added 3 entities to both allEntities arrays + imports
- `backend/src/infrastructure/persistence/database.module.ts` - added 3 entities to forFeature list + imports

### Other Config

- `autoLoadEntities: true` is correctly set
- `schema: 'alert_system'` is set in base PostgresConnectionOptions
- Connection pool, SSL, logging config all appropriate
- `synchronize` is properly guarded (non-production + explicit flag only)

---

## 4. Migrations

**No migration files found.**

The project uses `synchronize: true` for development and relies on TypeORM auto-sync. For production, `synchronize` is disabled (`NODE_ENV === 'production'`), and `DB_SYNCHRONIZE` env var must be explicitly set.

> **Recommendation**: Add migration support before production schema changes. Currently, any entity change requires manual SQL or re-enabling synchronize temporarily.

---

## 5. Relationships

**All relationships correctly configured:**

| Relationship | Type | Cascade | onDelete |
|-------------|------|---------|----------|
| User -> Alerts | OneToMany (implicit) | - | CASCADE |
| User -> BehaviorEvents | OneToMany (implicit) | - | CASCADE |
| User -> CommuteRecords | OneToMany (implicit) | - | CASCADE |
| User -> CommuteRoutes | OneToMany (implicit) | - | CASCADE |
| CommuteRoute -> RouteCheckpoints | OneToMany | cascade: true | CASCADE |
| CommuteRoute -> CommuteSessions | OneToMany | - | CASCADE |
| CommuteSession -> CheckpointRecords | OneToMany | cascade: true | CASCADE |
| RouteCheckpoint -> CheckpointRecords | OneToMany | - | CASCADE |
| User -> NotificationRules | OneToMany (implicit) | - | (none - nullable) |
| User -> PushSubscriptions | OneToMany (implicit) | - | CASCADE |
| User -> UserPlaces | OneToMany (implicit) | - | CASCADE |
| User -> CommuteEvents | OneToMany (implicit) | - | CASCADE |
| User -> SmartDepartureSettings | OneToMany (implicit) | - | CASCADE |
| User -> LiveActivityTokens | OneToMany (implicit) | - | CASCADE |
| User -> CommuteStreaks | OneToMany (implicit) | - | CASCADE |
| User -> UserChallenges | OneToMany (implicit) | - | CASCADE |
| User -> UserBadges | OneToMany (implicit) | - | CASCADE |

Notes:
- `cascade: true` is only used on CommuteRoute->Checkpoints and CommuteSession->CheckpointRecords, which is appropriate (parent owns children)
- All FK `onDelete` settings are sensible (CASCADE for owned entities, SET NULL for optional references)
- No eager loading is configured -- all relations are lazy by default (good for performance)

---

## 6. Indexes

**Well-indexed entities:**

| Entity | Indexes |
|--------|---------|
| CommuteRouteEntity | userId, (userId, routeType) |
| CommuteSessionEntity | userId, routeId, (userId, startedAt), status, (userId, status) partial unique |
| BehaviorEventEntity | userId, timestamp, eventType, (userId, timestamp) |
| UserPatternEntity | userId, patternType, (userId, patternType, dayOfWeek, isWeekday) unique |
| RouteCheckpointEntity | routeId, (routeId, sequenceOrder) |
| CheckpointRecordEntity | sessionId, checkpointId, (sessionId, arrivedAt) |
| CommuteEventEntity | userId, placeId, triggeredAt, (userId, triggeredAt), (userId, isProcessed) |
| PushSubscriptionEntity | userId, endpoint (unique), (userId, platform) |
| NotificationLogEntity | (userId, sentAt), sentAt |
| RouteAnalyticsEntity | routeId (unique), (totalScore, totalTrips) |
| SubwayStationEntity | name, (name, line) unique |
| UserPlaceEntity | userId, (userId, placeType) unique |
| SmartDepartureSnapshotEntity | (userId, departureDate), (settingId, departureDate) unique, status |
| CommuteStreakOrmEntity | userId (unique), lastRecordDate |
| StreakDailyLogOrmEntity | userId, recordDate, (userId, recordDate) unique |
| UserChallengeEntity | (userId, status), (userId, challengeTemplateId) partial unique |
| UserBadgeEntity | userId, (userId, badgeId) unique |
| LiveActivityTokenEntity | userId, activityId (unique), isActive |

All userId-based queries have appropriate indexes. Composite indexes exist for frequent query patterns.

---

## Summary

| Category | Status | Details |
|----------|--------|---------|
| Schema (alert_system) | PASS | All 29 entities use alert_system schema |
| Table naming (plural) | WARN | 5 cache/log tables use singular form |
| Column naming (boolean prefix) | WARN | 3 boolean columns missing is_/has_ prefix |
| TypeORM entity registration | FIXED | 3 entities added to database.config.ts + database.module.ts |
| Migrations | INFO | No migration files; relies on synchronize |
| Relationships | PASS | All correct with appropriate cascade/onDelete |
| Indexes | PASS | Comprehensive userId + composite indexes |
| Frontend Supabase schema | PASS | Correctly uses alert_system schema |
