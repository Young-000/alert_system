# Cycle 56: P4-1 Segment Congestion — Backend Implementation

## Date: 2026-03-02

## Summary

Implemented the full backend for P4-1 Segment Congestion feature. This is the first "data flywheel" feature: crowdsourced congestion levels computed from all users' checkpoint records via Bayesian smoothing, served through REST API endpoints.

## Completed

### Phase A: Entity + Repository
- **A1**: Created `SegmentCongestion` domain entity with `TimeSlot` (6 slots) and `CongestionLevel` (4 levels) types, plus utility methods (`determineCongestionLevel`, `isStale`, `hasMinimumSamples`)
- **A2**: Created `ISegmentCongestionRepository` interface, TypeORM entity (`segment_congestion` table), and repository implementation. Registered entity in `database.config.ts`

### Phase B: Aggregation Service
- **B1**: Implemented `normalizeSegmentKey()` — normalizes checkpoints by linkedStationId > linkedBusStopId > name+lineInfo. Strips Korean suffixes (역, 정류장, 정류소) iteratively
- **B2**: Implemented `classifyTimeSlot()` — classifies session startedAt into 6 KST-based time slots
- **B3**: Implemented `CongestionAggregationService.recalculateAll()` — full pipeline from checkpoint_records to segment_congestion via Bayesian smoothing (CONGESTION_PRIOR: mu=3, sigma=5)
- **B4**: Integration-level unit tests for Bayesian cold start (0-2 samples -> moderate default), convergence (10+ samples -> data-driven), and threshold boundaries

### Phase C: API Endpoints
- **C1**: `GET /congestion/segments` — query by timeSlot (auto-detect), level filter, limit
- **C2**: `GET /congestion/routes/:routeId` — JWT-guarded, maps route checkpoints to congestion via segment keys, computes overallCongestion
- **C3**: `POST /congestion/recalculate` — triggers full recalculation

### Phase D: Incremental Update
- **D1**: `updateForSession()` method in CongestionAggregationService — updates only affected segments when a session completes

### Phase G: Module Wiring
- **G1**: Created `CongestionModule` — registers all providers, imports CommuteModule for route repository, registered in `app.module.ts`

## Architecture Decisions

| Decision | Rationale |
|----------|-----------|
| Bayesian Normal-Normal conjugate (reused P3-1) | Handles small datasets gracefully; cold start defaults to "moderate" |
| determineCongestionLevel uses MAX(absolute, ratio) | Both absolute delay and delay ratio matter; take the worse |
| Segment key normalization: station ID > bus ID > name | Station IDs are stable across users; name normalization is fallback |
| Iterative suffix removal for Korean names | "서울역정류장" -> "서울역" -> "서울" requires multiple passes |
| Minimum 3 samples to show congestion | Prevents misleading data from 1-2 observations |

## Files Created
- `backend/src/domain/entities/segment-congestion.entity.ts`
- `backend/src/domain/repositories/segment-congestion.repository.ts`
- `backend/src/infrastructure/persistence/typeorm/segment-congestion.entity.ts`
- `backend/src/infrastructure/persistence/repositories/segment-congestion.repository.ts`
- `backend/src/application/services/congestion/segment-key.util.ts`
- `backend/src/application/services/congestion/time-slot.util.ts`
- `backend/src/application/services/congestion/congestion-aggregation.service.ts`
- `backend/src/application/services/congestion/congestion.service.ts`
- `backend/src/application/dto/congestion.dto.ts`
- `backend/src/presentation/controllers/congestion.controller.ts`
- `backend/src/presentation/modules/congestion.module.ts`

## Files Modified
- `backend/src/infrastructure/persistence/database.config.ts` — registered SegmentCongestionEntity
- `backend/src/presentation/app.module.ts` — registered CongestionModule

## Test Files Created
- `backend/src/domain/entities/segment-congestion.entity.spec.ts`
- `backend/src/application/services/congestion/segment-key.util.spec.ts`
- `backend/src/application/services/congestion/time-slot.util.spec.ts`
- `backend/src/application/services/congestion/congestion-aggregation.service.spec.ts`
- `backend/src/application/services/congestion/congestion.service.spec.ts`
- `backend/src/presentation/controllers/congestion.controller.spec.ts`

## Test Results
- **TypeScript**: 0 errors
- **Existing tests**: 1075 passed (0 regressions)
- **New tests**: 111 passed
- **Total**: 1186 passed, 10 skipped, 3 suites skipped
- **Test suites**: 92 passed of 95 total

## Next Steps
- Frontend: API client + React Query hooks for congestion endpoints
- Frontend: CongestionChip component + route detail page integration
- Daily cron job for automatic recalculation (03:00 KST)
- Hook incremental update into commute controller session completion flow
