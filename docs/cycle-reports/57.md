# Cycle 57: P4-1 Segment Congestion Frontend

**Date**: 2026-03-02
**PR**: P4-1 Congestion FE
**Status**: Complete

## Summary

Implemented the frontend layer for the segment congestion feature (P4-1). This adds congestion level indicators (CongestionChip) to the home page's commute section, allowing users to see real-time congestion data (low/moderate/high/severe) next to their transit checkpoints.

## Changes

### E1: API Client + React Query Hooks
- **`commute-api.client.ts`**: Added 8 new types (`TimeSlot`, `CongestionLevel`, `CongestionSegment`, `CongestionSegmentsResponse`, `RouteCongestionCheckpoint`, `RouteCongestionResponse`) and 2 new API methods (`getCongestionSegments`, `getRouteCongestion`)
- **`query-keys.ts`**: Added `congestion.segments()` and `congestion.byRoute()` query keys
- **`use-congestion-query.ts`**: Created `useCongestionSegments` and `useRouteCongestion` hooks with 5-minute staleTime
- **Mock file**: Added congestion types and mock methods for testing

### E2: CongestionChip Component
- **`CongestionChip.tsx`**: Reusable component with `sm` (dot + label) and `md` (dot + label + wait time + sample count) variants
- Color-coded: green (low/원활), yellow (moderate/보통), orange (high/혼잡), red (severe/매우혼잡)
- Shows "수집 중" (collecting) in gray when sampleCount < 3
- Full accessibility: `aria-label` describing congestion level and wait time
- **11 tests** covering all levels, size variants, collecting state, and accessibility

### E3: CommuteSection Integration
- **`CommuteSection.tsx`**: Added `useRouteCongestion` hook call; builds a name-based lookup map; renders `CongestionChip` next to each transit item that has matching congestion data
- Silent fail pattern: no loading spinner, no error state — chip only appears when data is available
- **4 new tests**: congestion chip shown with data, hidden without data, hidden with null congestion, "수집 중" with low sample count

### E4: CSS Styles
- **`congestion.css`**: CSS custom properties for congestion colors, `.congestion-chip--sm` and `--md` variants, level color classes, collecting state, CommuteSection integration styles
- Imported in `index.css`

## Verification Results

| Check | Result |
|-------|--------|
| TypeScript (`tsc --noEmit`) | 0 errors |
| ESLint (`--max-warnings=0`) | 0 warnings |
| Tests | 511 passed, 1 pre-existing failure (use-commute-mode toggle test, unrelated) |
| Build (`vite build`) | Success |
| New tests added | 15 (11 CongestionChip + 4 CommuteSection integration) |

## Files Changed

### New Files (4)
- `frontend/src/infrastructure/query/use-congestion-query.ts`
- `frontend/src/presentation/components/CongestionChip.tsx`
- `frontend/src/presentation/components/CongestionChip.test.tsx`
- `frontend/src/presentation/styles/pages/congestion.css`

### Modified Files (7)
- `frontend/src/infrastructure/api/commute-api.client.ts` — congestion types + API methods
- `frontend/src/infrastructure/query/query-keys.ts` — congestion query keys
- `frontend/src/infrastructure/query/index.ts` — export new hooks
- `frontend/src/__mocks__/infrastructure/api/index.ts` — congestion mocks + types
- `frontend/src/presentation/pages/home/CommuteSection.tsx` — congestion integration
- `frontend/src/presentation/pages/home/CommuteSection.test.tsx` — 4 new congestion tests
- `frontend/src/presentation/styles/index.css` — import congestion.css

## Architecture Notes

- Followed existing patterns exactly: class-based API client, singleton factory, React Query hooks with query keys
- CongestionChip is a standalone reusable component (not page-specific), placed in `presentation/components/`
- The congestion data lookup in CommuteSection uses a `Map<checkpointName, checkpoint>` built with `useMemo` for efficient matching
- CSS uses CSS custom properties for theming consistency, same pattern as other feature CSS files
