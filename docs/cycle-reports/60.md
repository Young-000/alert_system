# Cycle 60: P4-3 Backend — Social Route Community

## Summary
Implemented the complete backend for P4-3 Social Route Community feature: anonymous route neighbor detection, checkpoint tips CRUD with rate limiting, report/auto-hide moderation, and helpful toggle. Privacy is enforced at every layer — no user identifiers ever appear in API responses.

## Changes

### New Files (18)

**Domain Entities (3)**
- `src/domain/entities/community-tip.entity.ts` — CommunityTip domain model with content validation (100 char max, URL filter, profanity filter), auto-hide logic, daily rate limit check
- `src/domain/entities/community-tip-report.entity.ts` — CommunityTipReport domain model
- `src/domain/entities/checkpoint-key.util.ts` — Checkpoint key normalization (station:{id}, bus:{id}, name:{normalized}:{type}) and constants

**Repository Interfaces (3)**
- `src/domain/repositories/community-tip.repository.ts` — ICommunityTipRepository with find, count, save, increment/decrement operations
- `src/domain/repositories/community-tip-report.repository.ts` — ICommunityTipReportRepository for duplicate report prevention
- `src/domain/repositories/community-tip-helpful.repository.ts` — ICommunityTipHelpfulRepository for helpful toggle tracking

**TypeORM Entities (3)**
- `src/infrastructure/persistence/typeorm/community-tip.entity.ts` — Tips table with checkpoint_key index, author FK, timestamp columns
- `src/infrastructure/persistence/typeorm/community-tip-report.entity.ts` — Reports table with unique(tip_id, reporter_id) constraint
- `src/infrastructure/persistence/typeorm/community-tip-helpful.entity.ts` — Helpful tracking table with unique(tip_id, user_id) constraint

**Repository Implementations (3)**
- `src/infrastructure/persistence/repositories/community-tip.repository.ts` — TypeORM impl with KST-aware daily count
- `src/infrastructure/persistence/repositories/community-tip-report.repository.ts` — TypeORM impl
- `src/infrastructure/persistence/repositories/community-tip-helpful.repository.ts` — TypeORM impl with batch lookup

**DTOs (1)**
- `src/application/dto/community.dto.ts` — NeighborStatsDto, TipDto, TipsListResponseDto, CreateTipRequestDto/ResponseDto, ReportTipResponseDto, HelpfulTipResponseDto

**Services (2)**
- `src/application/services/community/community.service.ts` — Neighbor detection via checkpoint_key JOIN, avg duration comparison, privacy-safe stats
- `src/application/services/community/tips.service.ts` — Tips CRUD, rate limiting (3/day KST), report + auto-hide at 3 reports, helpful toggle

**Controller (1)**
- `src/presentation/controllers/community.controller.ts` — 5 endpoints: GET neighbors, GET tips, POST tip, POST report, POST helpful

**Module (1)**
- `src/presentation/modules/community.module.ts` — NestJS module wiring all providers

**Tests (5)**
- `src/domain/entities/community-tip.entity.spec.ts` — 14 tests (validation, auto-hide, rate limit)
- `src/domain/entities/checkpoint-key.util.spec.ts` — 10 tests (normalization, constants)
- `src/application/services/community/community.service.spec.ts` — 9 tests (neighbor detection, edge cases)
- `src/application/services/community/tips.service.spec.ts` — 19 tests (CRUD, rate limit, report, helpful, privacy)
- `src/presentation/controllers/community.controller.spec.ts` — 12 tests (endpoints, 429 mapping, privacy)

### Modified Files (4)
- `src/infrastructure/persistence/typeorm/route-checkpoint.entity.ts` — Added `checkpoint_key` column + index
- `src/infrastructure/persistence/database.config.ts` — Added 3 community entities to both SQLite and Postgres entity arrays
- `src/infrastructure/persistence/database.module.ts` — Registered community entities
- `src/presentation/app.module.ts` — Imported CommunityModule

## API Endpoints

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | `/community/neighbors?routeId=` | JWT | Neighbor count + avg time comparison |
| GET | `/community/tips?checkpointKey=&page=&limit=` | JWT | Paginated tips (no author info) |
| POST | `/community/tips` | JWT | Create tip (3/day limit, 3+ sessions required) |
| POST | `/community/tips/:id/report` | JWT | Report tip (auto-hide at 3 reports) |
| POST | `/community/tips/:id/helpful` | JWT | Toggle helpful on tip |

## Test Results
- **New tests: 69 passed** (5 test suites)
- **Full suite: 1348 passed** (101 suites, 3 pre-existing skips)
- **TypeScript: 0 errors**

## Privacy Guarantees
- No `authorId`, `userId`, `email`, or PII in any API response
- Neighbor stats are aggregated (count + average only)
- Tip DTOs contain only: id, content, helpfulCount, createdAt, isHelpfulByMe, isReportedByMe
- `authorId` is stored internally only for rate limiting enforcement
